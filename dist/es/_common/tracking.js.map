{"version":3,"file":"tracking.js","sources":["../../../src/_common/tracking.js"],"sourcesContent":["import { deleteAllCookies } from './cookieUtils'\nimport {\n  getStorageItem,\n  setStorageItem,\n  storageItemExists,\n} from './storageUtils'\n\nconst TRACKING_CONSENT_STORAGE_NAME = 'kh_tracking'\nconst TRACKING_CONSENT_VALUES = {\n  accept: 'accept',\n  reject: 'reject',\n}\nconst GATSBY_GOOGLE_ANALYTICS_ID = process.env.GATSBY_GOOGLE_ANALYTICS_ID\nconst disableStr = `ga-disable-${GATSBY_GOOGLE_ANALYTICS_ID}`\nconst IS_DEVELOPMENT = process.env.NODE_ENV === 'development'\n\n// user is opting out, setting cookie on document, window and alerting success\nconst gaOptOut = () => {\n  document.cookie = `${disableStr}=true; expires=Thu, 31 Dec 2099 23:59:59 UTC; path=/`\n  window[disableStr] = true\n}\n\nconst gaOptIn = () => {\n  document.cookie = `${disableStr}= ; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`\n  window[disableStr] = null\n}\n\n// NOTE: getHasConsent() - We need to keep this one for use outside of react's render cycle.\nconst getHasConsent = () => {\n  return (\n    !storageItemExists(TRACKING_CONSENT_STORAGE_NAME) ||\n    getStorageItem(TRACKING_CONSENT_STORAGE_NAME) === 'accept'\n  )\n}\n\nfunction getCanTrack() {\n  return typeof window !== 'undefined' && getHasConsent()\n}\n\n/**\n * @deprecated use tracking.track() instead\n */\nconst trackEvent = (payload) => {\n  if (typeof window === 'undefined' || !getHasConsent() || !window.gtag) return\n  if (payload.action || payload.label || payload.category) trackGAEvent(payload)\n  if (payload.dcCode) trackDCEvent(payload.dcCode)\n}\n\nconst trackGAEvent = (payload) => {\n  window.gtag('event', payload.action, {\n    send_to: process.env.GATSBY_GOOGLE_ANALYTICS_ID,\n    event_category: payload.category,\n    event_label: payload.label,\n    ...(payload.value && { value: payload.value }),\n  })\n}\n\nconst trackDCEvent = (dcCode) => {\n  window.gtag('event', 'conversion', {\n    allow_custom_scripts: true,\n    send_to: `${process.env.GATSBY_GOOGLE_DOUBLECLICK_ID}/${dcCode}`,\n    session_id: getStorageItem('session_id'),\n  })\n}\n\nfunction noop() {}\n\nfunction getIsNewSyntax(args) {\n  return typeof args[0] === 'string'\n}\n\n/**\n * @deprecated use trackingSegment instead\n */\nconst trackingGA = {\n  // page() is a noop because this is actually handled by the gatsby-google-gtag-plugin\n  page: noop,\n  // identify() is a noop because gtag does not have this functionality\n  identify: noop,\n  track: (...args) => {\n    if (!getCanTrack()) return\n\n    const transformedArgs = getIsNewSyntax(args) ? [args[1]] : args\n\n    trackEvent(...transformedArgs)\n  },\n  getHasConsent,\n  getConsentValue: () => {\n    return getStorageItem(TRACKING_CONSENT_STORAGE_NAME)\n  },\n  optIn: () => {\n    setStorageItem(\n      TRACKING_CONSENT_STORAGE_NAME,\n      TRACKING_CONSENT_VALUES.accept\n    )\n    gaOptIn()\n  },\n  optOut: () => {\n    setStorageItem(\n      TRACKING_CONSENT_STORAGE_NAME,\n      TRACKING_CONSENT_VALUES.reject\n    )\n    gaOptOut()\n    deleteAllCookies()\n  },\n}\n\nconst trackingSegment = {\n  page: (...args) => {\n    if (!getCanTrack()) return\n\n    window.analytics.page(...args)\n  },\n  identify: (...args) => {\n    if (!getCanTrack()) return\n\n    window.analytics.identify(...args)\n  },\n  track: (...args) => {\n    if (!getCanTrack()) return\n\n    if (IS_DEVELOPMENT && !getIsNewSyntax(args)) {\n      throw new Error(\n        'Invalid tracking.track() call signature. Ensure you pass a string as the first parameter.'\n      )\n    }\n\n    window.analytics.track(...args)\n  },\n  getHasConsent,\n  getConsentValue: () => {\n    return getStorageItem(TRACKING_CONSENT_STORAGE_NAME)\n  },\n  optIn: () => {\n    setStorageItem(\n      TRACKING_CONSENT_STORAGE_NAME,\n      TRACKING_CONSENT_VALUES.accept\n    )\n  },\n  optOut: () => {\n    setStorageItem(\n      TRACKING_CONSENT_STORAGE_NAME,\n      TRACKING_CONSENT_VALUES.reject\n    )\n    deleteAllCookies()\n  },\n}\n\n// const isSegmentEnabled = !!process.env.GATSBY_SEGMENT_KEY\nconst isSegmentEnabled = false\n\nexport const tracking = isSegmentEnabled ? trackingSegment : trackingGA\n"],"names":["TRACKING_CONSENT_STORAGE_NAME","TRACKING_CONSENT_VALUES","accept","reject","GATSBY_GOOGLE_ANALYTICS_ID","process","env","disableStr","NODE_ENV","gaOptOut","document","cookie","window","gaOptIn","getHasConsent","storageItemExists","getStorageItem","getCanTrack","trackEvent","payload","gtag","action","label","category","trackGAEvent","dcCode","trackDCEvent","send_to","event_category","event_label","value","allow_custom_scripts","GATSBY_GOOGLE_DOUBLECLICK_ID","session_id","noop","getIsNewSyntax","args","trackingGA","page","identify","track","transformedArgs","getConsentValue","optIn","setStorageItem","optOut","deleteAllCookies","tracking"],"mappings":"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"}